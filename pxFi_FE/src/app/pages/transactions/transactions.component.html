<ion-content>
  
  <ion-header>
    <ion-toolbar>
      <ion-title>Transactions</ion-title>
    </ion-toolbar>
  </ion-header>

  @if (isLinkingMode) {
    <div class="alert alert-info">
      Select one expense (red) and one income (green) transaction to link them as a split bill.
    </div>
  }

  @if (loading) {
    <div class="text-center p-5">
      <ion-spinner></ion-spinner>
      <p class="mt-2">Loading transactions...</p>
    </div>
  }

  @if (error) {
    <div class="alert alert-danger text-center">
      {{ error }}
    </div>
  }

  @if (!loading && !error && displayedTransactions.length > 0) {
    <ion-list>
      @for (tx of displayedTransactions; track tx.id) {
        <div class="transaction-wrapper">
          <ion-item class="transaction-item" lines="none" (click)="tx.expanded = !tx.expanded">
            <ion-icon [name]="iconService.getIconForCategory(categoryService.getCategoryName(tx.categoryId!))" slot="start" class="transaction-icon"></ion-icon>
            <ion-label>
              <div class="transaction-description">{{ tx.remittanceInformationUnstructured }}</div>
              <div class="transaction-category">
                {{ categoryService.getCategoryName(tx.categoryId!) || 'Uncategorized' }}
                @if(tx.subCategoryId) {
                  <span> &middot; {{ categoryService.getSubCategoryName(tx.categoryId!, tx.subCategoryId!) }}</span>
                }
                &middot; {{ tx.bookingDate | date:'shortDate' }}
              </div>
            </ion-label>
            <div slot="end" class="transaction-amount" [class.positive]="+tx.transactionAmount.amount > 0" [class.negative]="+tx.transactionAmount.amount < 0">
              {{ tx.transactionAmount.amount | currency:tx.transactionAmount.currency }}
            </div>
          </ion-item>
          @if (tx.expanded) {
            <div class="category-editor">
              <ion-item>
                <ion-label>Category</ion-label>
                <ion-select [(ngModel)]="tx.categoryId" (ionChange)="onCategorySelectionChange(tx)" interface="popover">
                  @for (cat of mainCategories; track cat) {
                    <ion-select-option [value]="cat.id">{{ cat.name }}</ion-select-option>
                  }
                </ion-select>
              </ion-item>
              @if (tx.categoryId && categoryService.getSubCategories(tx.categoryId).length > 0) {
                <ion-item>
                  <ion-label>Subcategory</ion-label>
                  <ion-select [(ngModel)]="tx.subCategoryId" (ionChange)="onSubCategorySelectionChange(tx)" interface="popover">
                    @for (subCat of categoryService.getSubCategories(tx.categoryId); track subCat) {
                      <ion-select-option [value]="subCat.id">{{ subCat.name }}</ion-select-option>
                    }
                  </ion-select>
                </ion-item>
              }
              <div class="ion-padding-start ion-padding-end ion-padding-bottom d-flex justify-content-end">
                <ion-button (click)="saveCategory(tx)" [disabled]="!tx.categoryDirty">Save</ion-button>
              </div>
            </div>
          }
        </div>
      }
    </ion-list>

    <ion-infinite-scroll (ionInfinite)="loadMore($event)">
      <ion-infinite-scroll-content loadingSpinner="bubbles" loadingText="Loading more transactions...">
      </ion-infinite-scroll-content>
    </ion-infinite-scroll>
  }

  @if (!loading && !error && filteredTransactions.length === 0) {
    <div class="text-center p-5">
        <i class="fas fa-search-dollar fa-3x text-muted mb-3"></i>
        <h4>No Transactions Found</h4>
        <p class="text-muted">
            There are no transactions that match your current filters. <br>
            Try clearing the date filter or selecting a different category.
        </p>
    </div>
  }

  <ion-fab slot="fixed" vertical="bottom" horizontal="start" class="custom-fab">
    <ion-fab-button>
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
    <ion-fab-list side="end">
      <ion-fab-button (click)="openFilterModal()" color="light" data-desc="Filter">
        <ion-icon name="funnel"></ion-icon>
      </ion-fab-button>
      <ion-fab-button (click)="refreshTransactions()" color="light" data-desc="Refresh">
        <ion-icon name="refresh"></ion-icon>
      </ion-fab-button>
      <ion-fab-button (click)="toggleLinkingMode()" color="light" data-desc="Split Bill">
        <ion-icon name="link"></ion-icon>
      </ion-fab-button>
    </ion-fab-list>
  </ion-fab>
</ion-content>
