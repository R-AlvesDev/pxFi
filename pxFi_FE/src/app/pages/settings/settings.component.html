<div class="container py-4">
  <h2 class="mb-4">Settings</h2>

  <div class="row g-4">
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header"><h5 class="mb-0">Manage Categories</h5></div>
        <div class="card-body">
          <form (ngSubmit)="addCategory()" class="mb-4 p-3 border rounded bg-light">
            <h6 class="mb-3">Add New Category</h6>
            <div class="mb-2">
              <label for="newCategoryName" class="form-label">Name</label>
              <input type="text" class="form-control" [(ngModel)]="newCategoryName" name="newCategoryName" required>
            </div>
            <div class="mb-3">
              <label for="newCategoryParent" class="form-label">Parent (Optional)</label>
              <select class="form-select" [(ngModel)]="newCategoryParentId" name="newCategoryParentId">
                <option [ngValue]="null">-- Main Category --</option>
                @for (cat of mainCategories; track cat) {
                  <option [value]="cat.id">{{ cat.name }}</option>
                }
              </select>
            </div>
            <button type="submit" class="btn btn-primary w-100">Add Category</button>
          </form>

          <h6 class="mt-4 border-bottom pb-2 mb-3">Existing Categories</h6>
          <ul class="list-group">
            @for (category of mainCategories; track category) {
              <li class="list-group-item">
                <div class="d-flex justify-content-between align-items-center" (click)="toggleCategory(category.id)" style="cursor: pointer;">
                    <div>
                        <strong>{{ category.name }}</strong>
                    </div>
                    <button class="btn btn-outline-danger btn-sm" (click)="$event.stopPropagation(); deleteCategory(category.id)">Delete</button>
                </div>
              </li>
              @if (expandedCategoryIds.has(category.id)) {
                @for (sub of categoryService.getSubCategories(category.id); track sub) {
                  <li class="list-group-item d-flex justify-content-between align-items-center ps-5">
                     <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" [id]="'asset-transfer-' + sub.id" 
                               [(ngModel)]="sub.isAssetTransfer" 
                               (ngModelChange)="onAssetTransferChange(sub)">
                        <label class="form-check-label" [for]="'asset-transfer-' + sub.id">
                            {{ sub.name }}
                        </label>
                    </div>
                    <button class="btn btn-outline-danger btn-sm" (click)="$event.stopPropagation(); deleteCategory(sub.id)">Delete</button>
                  </li>
                }
              }
            }
          </ul>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header"><h5 class="mb-0">Manage Automation Rules</h5></div>
        <div class="card-body d-flex flex-column">
          <form (ngSubmit)="createRule()" class="mb-4 p-3 border rounded bg-light">
            <h6 class="mb-3">Add New Rule</h6>
            <div class="input-group mb-2">
              <span class="input-group-text">IF</span>

              <select class="form-select" [(ngModel)]="newRule.fieldToMatch" name="fieldToMatch" (ngModelChange)="onFieldToMatchChange()">
                @for (field of ruleFields; track field) {
                  <option [value]="field">{{ field }}</option>
                }
              </select>

              <select class="form-select" [(ngModel)]="newRule.operator" name="operator">
                @for (op of availableOperators; track op) {
                  <option [value]="op">{{ op }}</option>
                }
              </select>

              <input type="text" class="form-control" placeholder="Value..." [(ngModel)]="newRule.valueToMatch" name="valueToMatch">
            </div>
            <div class="input-group">
              <span class="input-group-text">THEN</span>
              <select class="form-select" [(ngModel)]="newRule.categoryId" name="categoryId">
                <option [ngValue]="undefined">Select Category</option>
                @for (cat of mainCategories; track cat) {
                  <option [value]="cat.id">{{ cat.name }}</option>
                }
              </select>
              @if (newRule.categoryId) {
                <select class="form-select" [(ngModel)]="newRule.subCategoryId" name="subCategoryId">
                  <option [ngValue]="null">No Subcategory</option>
                  @for (sub of categoryService.getSubCategories(newRule.categoryId!); track sub) {
                    <option [value]="sub.id">{{ sub.name }}</option>
                  }
                </select>
              }
            </div>
            <div class="d-flex gap-2 mt-3">
              <button type="button" class="btn btn-outline-info w-50" (click)="testRule()">Test Rule</button>
              <button type="submit" class="btn btn-primary w-50">Add Rule</button>
            </div>
          </form>

          <hr>
            <div class="d-grid">
              <button class="btn btn-secondary" (click)="applyAllRules()" [disabled]="isApplyingRules">
                @if (isApplyingRules) {
                  <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                }
                {{ isApplyingRules ? 'Applying...' : 'Apply All Rules to Existing Transactions' }}
              </button>
            </div>
            <hr>

              <div class="flex-grow-1" style="overflow-y: auto;">
                <ul class="list-group">
                  @if ((rules$ | async)?.length === 0) {
                    <li class="list-group-item text-muted text-center">
                      No rules created yet.
                    </li>
                  }
                  @for (rule of rules$ | async; track rule) {
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                      <div>
                        <small class="text-muted">IF {{ rule.fieldToMatch }} {{ rule.operator }} "{{ rule.valueToMatch }}"</small><br>
                        <strong>THEN âžž {{ getCategoryName(rule.categoryId) }} @if (rule.subCategoryId) {
                          <span>/ {{ getCategoryName(rule.subCategoryId) }}</span>
                        }</strong>
                      </div>
                      <button class="btn btn-outline-danger btn-sm" (click)="deleteRule(rule.id)">Delete</button>
                    </li>
                  }
                </ul>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="testRuleModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Rule Test Results</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            @if (testResults) {
              <div>
                <div class="alert alert-info">
                  This rule matched <strong>{{ testResults.matchCount }}</strong> transaction(s) for the currently selected account.
                </div>
                <ul class="list-group">
                  @if (testResults.matchCount === 0) {
                    <li class="list-group-item text-muted text-center">
                      No matching transactions found.
                    </li>
                  }
                  @for (tx of testResults.matchedTransactions; track tx) {
                    <li class="list-group-item">
                      <div class="d-flex justify-content-between">
                        <span>{{ tx.remittanceInformationUnstructured }}</span>
                        <span [ngClass]="+tx.transactionAmount.amount > 0 ? 'text-success' : 'text-danger'">
                          {{ tx.transactionAmount.amount | currency:tx.transactionAmount.currency }}
                        </span>
                      </div>
                      <small class="text-muted">{{ tx.bookingDate | date:'mediumDate' }}</small>
                    </li>
                  }
                </ul>
              </div>
            }
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>